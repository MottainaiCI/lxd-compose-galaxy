name: "mottainai-database"
description: "Install ArangoDB Backend for Mottainai Server"
connection: "{{ .Values.connection }}"

common_profiles:
- default
- net-mottainai0
{{ if .Values.mottainai.privileged_containers }}
- privileged
{{ end }}

ephemeral: {{ .Values.ephemeral }}

nodes:
- name: mottainai-database
  image_source: "sabayon/arangodb"
  image_remote_server: "keybase-geaaru"
  profiles:
{{ if .Values.mottainai.enable_storage_from_host }}
    - arangodb-data
{{ end }}

# Group hooks
hooks:
  - event: post-node-creation
    commands:
      - |
        echo "
        # Repository configuration file automatically generated
        # by sabayon-repo-generator script.
        [sabayonlinux.org]
        desc = Sabayon Linux Official Repository
        enabled =  true
        repo = http://sabayonlinux.mirror.garr.it/sabayon/entropy
        pkg = http://sabayonlinux.mirror.garr.it/sabayon/entropy
        " > /etc/entropy/repositories.conf.d/entropy_sabayonlinux.org

      - enman remove geaaru
      - equo update && equo upgrade
      - equo i enman app-misc/jq
      - equo update
      - equo i $(echo ${arangodb_packages} | jq '.[]' -r)
      - curl https://raw.githubusercontent.com/geaaru/luet/geaaru/contrib/config/get_luet_root.sh | sh
      - luet install --sync-repos $(echo ${luet_repositories} | jq '.[]' -r)
      - luet install --sync-repos $(echo ${arangodb_luet_packages} | jq '.[]' -r)
      - systemctl enable arangodb3
      - equo cleanup && luet cleanup

  - event: post-node-sync
    commands:
      - |
        echo "${arangod_conf_tmp}" > /etc/arangodb3/arangod.conf
      - systemctl restart arangodb3
      - sleep 1

  - event: post-node-sync
    flags:
      - initdb
    commands:
      - |
        echo "require(\"org/arangodb/users\").update(\"root\", \"${arango_root_pwd}\");" | arangosh --server.password "" --quiet true
      - |
        echo "db._createDatabase(\"${arango_db}\");" | arangosh --server.password "" --quiet true || true
      - |
        echo "require('@arangodb/users').save(\"${arango_user}\", \"${arango_user_pwd}\");" | arangosh --server.password "" --quiet true || true
      - |
        echo "require('@arangodb/users').grantCollection(\"${arango_user}\", \"${arango_db}\", '*', 'rw');" | arangosh --server.password "" --quiet true
      - |
        echo "require('@arangodb/users').grantDatabase(\"${arango_user}\", \"${arango_db}\", 'rw');" | arangosh --server.password "" --quiet true
      - |
        echo "require('@arangodb/users').permission(\"${arango_user}\", \"${arango_db}\")" | arangosh --server.password "" --quiet true

  - event: post-node-sync
    commands:
      - echo "${arangod_conf}"
      - |
        echo "${arangod_conf}" > /etc/arangodb3/arangod.conf
      - systemctl restart arangodb3


